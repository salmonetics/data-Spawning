<html lang="en">
<head>
    <title>QRF Browser</title>

    <meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="/script/dc.js/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/script/dc.js/dc.css"/>
	<script src="/script/jquery-1.12.2.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script src="https://d3js.org/queue.v1.min.js"></script>
	<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<!--<script src="//d3js.org/topojson.v1.min.js"></script>-->
	<script type="text/javascript" src="/script/dc.js/colorbrewer.js"></script>
	<link rel="stylesheet" type="text/css" href="/script/dc.js/ColorBrewerCSS.css"/>
	<script type="text/javascript" src="/script/crossfilter.min.js"></script>
	<script type="text/javascript" src="/script/dc.js/dc.js.2.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.css">	
	<!--
	<script type="text/javascript" src="SitesBasins.js"></script>
	<script type="text/javascript" src="CrossTrack4c.js"></script>
	-->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
  integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
  crossorigin=""/>
  <!--<link rel="stylesheet" href="/script/dvf.css" type="text/css" media="screen"/>-->
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
  integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
  crossorigin=""></script>
  
  <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
  
  <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css"></link>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css"></link>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/1.4.0/regression.min.js"></script>

  <!--<script type="text/javascript" src="/script/leaflet-dvf.js"></script>-->
  <script type="text/javascript" src="map_utils2.js"></script>
  
  
<style>

.popuptable{
	font-size: 12;
}
#chart-year .x.axis text {
	text-anchor: end !important;;
	transform: rotate(-45deg);
	font-size: 12;
}

#redds-year .x.axis text {
	text-anchor: end !important;;
	transform: rotate(-45deg);
	font-size: 12;
}

.leaflet-popup-content { width:500px; }	
img.leaflet-tile{
	pointer-events: none;
}
.action_marker{
	pointer-events: all;
	cursor: pointer;
}	
#leafmap{
	width: 800px;
	height: 700px;	
}	
.dataicon{
	width: 200px;
	height: 200px;	
}

.damicon i{
	width: 6px;
	height: 6px;
	float: left;
	margin-right: 5px;
}	

.control {margin:5px;}
#datarow {
	height: 300px;
	overflow: scroll;
}


#spinner * { 
	filter: none; 
	-moz-opacity: 100%; 
	position: absolute;
	top: 200px;
	left: 650px;
}
	
div.tooltip {   
  position: absolute;           
  text-align: left;                            
  padding: 2px;             
  font: 16px sans-serif;        
  background: #fff;   
  border: 0px;      
  border-radius: 8px;           
  pointer-events: none;         
}

svg	{ overflow: hidden; }
	
	table {
	margin: 10px;
	padding-top: 2px;
    padding-right: 10px;
    padding-bottom: 2px;
    padding-left: 10px;
	}
	
.dc-table-label {
font-weight: bold;
}

.header th {
text-align: center;	
}

.tiptable {
	font: 12px sans-serif;
}

.axis path, .axis line {
    fill: none;
    shape-rendering: crispedges;
    stroke: #000000;
}
.grid .tick {
    stroke: grey;
    opacity: 0.5 !important;
}
.bar rect {
        fill: #ed1e79;
    }

    .bar text.value {
        fill: black;
    }
    circle {
    fill: none;
    stroke: black; 
    stroke-width: 1;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

text {
  cursor: default;
}

path.line:hover{
	stroke-width: 2px;
}

.background path {
  fill: none;
  stroke: #ddd;
  shape-rendering: crispEdges;
}

.foreground path {
  fill: none;
  stroke: steelblue;
}

.brush .extent {
  fill-opacity: .3;
  stroke: #fff;
  shape-rendering: crispEdges;
}

.axis line,
.axis path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
  cursor: move;
}

input[type=range],
	::-moz-range-track,
	 ::-ms-track {
	 -webkit-appearance: none;
	 background-color: 3f91e5;
	 width: 400px;
	 height:40px;
}

input.vertical {
	-webkit-appearance: slider-vertical;
	writing-mode: bt-lr;
}
	</style>
</head>
<body>
<div class="container-fluid">
<div class="row">
<div class="span8">
<div id="dc-data-count">
        <span class="filter-count"></span> selected out of <span class="total-count"></span> rows&nbsp;<span><a href="javascript:dc.filterAll(); redrawAll();">(reset all)</a></span>
    </div>
</div>
</div>
<div class="row">
<div class="span5">
  <ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#filter1">What</a></li>
	<li><a data-toggle="tab" href="#filter3">Where</a></li>
	<li><a data-toggle="tab" href="#filter5">Options</a></li>
  </ul>

<div class="tab-content">

    <div id="filter1" class="tab-pane fade in active">
	    <fieldset>
        <strong>Select Species</strong>       
        <p>
            <input type="radio" name="specie" value="Chinook" checked onclick="selectSpecies('Chinook');"/> Chinook<br/>
            <input type="radio" name="specie" value="Steelhead" onclick="selectSpecies('Steelhead');"/> Steelhead<br/>
        </p>
		</fieldset>
		<fieldset>
		 <strong>Select Lifestage</strong>       
        <p>
            <input type="radio" name="lifestage" value="Summer" checked onclick="selectLifestage('Summer');"/> Summer<br/>
            <input type="radio" name="lifestage" value="Overwinter" onclick="selectLifestage('Overwinter');"/> Overwinter<br/>
			<input type="radio" name="lifestage" value="Redds" onclick="selectLifestage('Redds');"/> Redds<br/>
        </p>
		</fieldset>
		<fieldset>
		 <strong>Select Variable</strong>       
        <p>
            <input type="radio" name="aggvariable" value="perM" checked onclick="params.QRF.variable='perM';redrawAll();"/> perM<br/>
            <input type="radio" name="aggvariable" value="perM2" onclick="params.QRF.variable='perM2';redrawAll();"/> perM2<br/>
        </p>
		</fieldset>		
		
		<div id="chart-hasdata" class="control">
			<div><strong>CHaMP Site?</strong>
			<a class="reset" href="javascript:hasdata.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>	
	</div>
	
    <div id="filter2" class="tab-pane fade">
<!--	
		<div id="chart-program" class="control">
			<div><strong>Program</strong>
			<a class="reset" href="javascript:program.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		-->
		<div id="chart-method" class="control">
			<div><strong>Method</strong>
			<a class="reset" href="javascript:method.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		<!--
		<div id="chart-stype" class="control">
			<div><strong>Survey Type</strong>
			<a class="reset" href="javascript:stype.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>		
		<div id="chart-agency" class="control">
			<div><strong>Agency</strong>
			<a class="reset" href="javascript:agency.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		-->		
	</div>
    <div id="filter3" class="tab-pane fade">
		<div id="chart-huc3name" class="control">
			<div><strong>Basin</strong>
			<a class="reset" href="javascript:huc3name.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>	
		<div id="chart-huc4name" class="control">
			<div><strong>Subbasin</strong>
			<a class="reset" href="javascript:huc4name.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		<div id="chart-huc5name" class="control">
			<div><strong>Watershed</strong>
			<a class="reset" href="javascript:huc5name.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		<div id="chart-huc6name" class="control">
			<div><strong>Subwatershed</strong>
			<a class="reset" href="javascript:huc6name.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>	
		<div id="chart-pop" class="control">
			<div><strong>Population</strong>
			<a class="reset" href="javascript:population.filterAll();redrawAll();" style="display: none;">reset</a>
			</div>
		</div>			
	</div>
    <div id="filter4" class="tab-pane fade">
	
	</div>
	<div id="filter5" class="tab-pane fade">
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">HUC Style</th></tr>
		<tr><td align="left" colspan=2><input type="radio" name="hucstyle" value="1" checked onclick="params.HUC.style='valuefill';"></input>&nbsp;<span class="dropdown_text">Filled by Mean Value</span></td></tr>
		<tr><td align="left"colspan=2><input type="radio" name="hucstyle" value="1" onclick="params.HUC.style='outline';"></input>&nbsp;<span class="dropdown_text">Outline Only</span></td></tr>
		<tr><th align="left" class="dropdown_text">HUC Border Color</th><td><input id="hucborder_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">HUC Label Color</th><td><input id="huclabel_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">Label Font Size</th>
		<td align="left"><input id="huclabel_slider" type = "range" min ="14" max="32" step ="2" value ="24"/></td></tr>
		<tr><th align="left" class="dropdown_text">HUC Label Width</th>
		<td align="left"><input id="huclabelwidth_slider" type = "range" min ="60" max="400" step ="20" value ="200"/></td></tr>		
		</table>
		<br>
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">Pop Border Color</th><td><input id="pop_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">Pop Label Color</th><td><input id="poplabel_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">Label Font Size</th>
		<td align="left"><input id="poplabel_slider" type = "range" min ="16" max="48" step ="2" value ="28"/></td></tr>
		<tr><th align="left" class="dropdown_text">Pop Label Width</th>
		<td align="left"><input id="poplabelwidth_slider" type = "range" min ="60" max="400" step ="20" value ="200"/></td></tr>		
		</table>		
<!--		
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">Marker Scale/Color</th></tr>
		<tr><td align="left"><input id="circlesize_slider" type = "range" min ="1" max="100" step ="1" value ="20"/>&nbsp;<input id='circle_colorpicker'/>
		</td></tr>
		</table>
		
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">Species Pie Size/Colors</th></tr>
		<tr><td align="left"><input id="piesize_slider" type = "range" min ="1" max="100" step ="1" value ="20"/></tr>
		<tr><td align="left">
		<select id="species_palette" onchange="toggleSpeciesPalette(this)"></select>
		</td></tr>
		</table>		
		
		<table cellpadding="3">
		<tr><th class="dropdown_text" align="right" colspan="2">River Coloring</th>
		<td><select id="riverstyle_options" class="dropdown_text" onchange="styleRivers(this)">
		<option value="styleRiverBlue" id="styleRiverBlue">Default Blue</option>
		<option value="styleRiverTemp" id="styleRiverTemp">Mean Aug Temp C</option>
		<option value="styleRiverTemp2011" id="styleRiverTemp2011">Aug Temp Rating</option>
		<option value="styleRiverTemp2040" id="styleRiverTemp2040">2040 Temp Rating</option>
		<option value="styleRiverElevation" id="styleRiverElevation">Elevation</option>
		<option value="styleRiverCanopy" id="styleRiverCanopy">Canopy</option>
		<option value="styleRiverVelocity" id="styleRiverVelocity">Stream Velocity</option>
		<option value="styleRiverSlope" id="styleRiverSlope">Stream Slope</option>
		<option value="styleRiverPrecip" id="styleRiverPrecip">Precipitation</option>
		</select>
		</td>
		</tr>
		</table>
-->		
	</div>	
</div>	
</div>

<div class="span14">

  <ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#filter10">Map</a></li>
	<li><a data-toggle="tab" href="#filter20">TBD</a></li>
  </ul>

<div class="tab-content">
<div id="filter10" class="tab-pane fade in active">
	<div id="leafmap">
	</div>
</div>
<div id="filter20" class="tab-pane fade">
		<table cellpadding="3">
		<tr><th align="left">Aggregation</th>
		<td><input type="radio" name="time_agg" value="SurveyDate" checked onclick="params.timeseries.timestep='SurveyDate';redrawAll()"></input>&nbsp;<span class="dropdown_text">Day</span></td>
		<td><input type="radio" name="time_agg" value="Week" onclick="params.timeseries.timestep='Week';redrawAll()"></input>&nbsp;<span class="dropdown_text">Week</span></td>
		<td><input type="radio" name="time_agg" value="Month" onclick="params.timeseries.timestep='Month';redrawAll()"></input>&nbsp;<span class="dropdown_text">Month</span></td>
		<td><input type="radio" name="time_agg" value="Year" onclick="params.timeseries.timestep='SurveyYear';redrawAll()"></input>&nbsp;<span class="dropdown_text">Year</span></td>
		</tr>
		<tr><th align="left" class="dropdown_text">Bar Width</th>
		<td align="left" colspan="3"><input id="barsize_slider" type = "range" min ="1" max="100" step ="1" value ="4"/></td></tr>
		</table>
	<div id="fishplot">
	</div>
</div>
</div>
</div>
</div>

<div class="row" id="loc_info">

</div>

</div>

<div id="spinner"><img src="/images/spinner.gif"></div>
</body>

<script>
var tipdiv = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

$("#hucborder_colorpicker").spectrum({
    color: "#fff",
	hide: function(tinycolor) {
		params.HUC.bordercolor = "#" + tinycolor.toHex();
	},
});

$("#huclabel_colorpicker").spectrum({
    color: "#000",
	hide: function(tinycolor) {
		params.HUC.labelcolor = "#" + tinycolor.toHex();
		d3.selectAll(".huclabeltable").style("color",params.HUC.labelcolor)
	},
});

$("#poplabel_colorpicker").spectrum({
    color: "#000",
	hide: function(tinycolor) {
		params.population.labelcolor = "#" + tinycolor.toHex();
		d3.selectAll(".poplabeltable").style("color",params.population.labelcolor)
	},
});	

$("#pop_colorpicker").spectrum({
    color: "orange",
	hide: function(tinycolor) {
		params.population.color = "#" + tinycolor.toHex();
	},
});

$("#huclabel_slider").on("input", function(){
	params.HUC.labelsize = +this.value;
	d3.selectAll(".huclabeltable td").style("font-size",params.HUC.labelsize)
});	

$("#poplabel_slider").on("input", function(){
	params.population.labelsize = +this.value;
	d3.selectAll(".poplabeltable td").style("font-size",params.population.labelsize)
});

$("#huclabelwidth_slider").on("input", function(){
	params.HUC.labelwidth = +this.value;
	d3.selectAll(".huclabeltable").style("width",params.HUC.labelwidth)
});

$("#poplabelwidth_slider").on("input", function(){
	params.population.labelwidth = +this.value;
	d3.selectAll(".poplabeltable").style("width",params.population.labelwidth)
});

var ndx;

var params = {
	circle_size:{
		scale: 1, 
		metric: "mean_count",
		statistic: "mean",
		fxn: "log10"
	},
	population: {
		color: "orange",
		labelsize: 28,
		labelcolor: "#000000",
		labelwidth: 200
	},
	pie: {
		scale: 10,
		rmax: 30,
		display: false,
		sliderscale: 1,
		palette: "Blues",
		colorlevels: 6,
		palette_invert: true
	},
	HUC: {
		LabelLayer: null,
		style: "valuefill",
		labelwidth: 200,
		labelsize: 24,
		labelcolor: "#000000",
		bordercolor: "#ffffff"
	},
	QRF: {
		aggregation_level: "HUC3",
		variable: "perM",
		breaks:{
			Chinook:
			{
			  Summer: {
				perM: [1, 2, 4, 6, 8],
				perM2: [.1,.2,.3,.4,.5]
			  },
			  Overwinter:{
				perM: [1, 2, 4, 6, 8],
				perM2: [.1,.2,.3,.4,.5]
			  },
			  Redds:{
				perM: [.01,.02,.03,.04,.05],
				perM2: [.0025, .005, .0075, .01, .015]
			  }
			},
			Steelhead:
			{
			  Summer: {
				perM: [1, 2, 4, 6, 8],
				perM2: [.1,.2,.3,.4,.5]
			  },
			  Overwinter:{
				perM: [1, 2, 4, 6, 8],
				perM2: [.1,.2,.3,.4,.5]
			  },
			  Redds:{
				perM: [.01,.02,.03,.04,.05],
				perM2: [.0025, .005, .0075, .01, .015]
			  }
			},			
		}
	}
}

var basins = {
"170200": {name: "Upper Columbia", latitude: 47.95625, longitude: -120.1890},
"170300": {name: "Yakima", latitude: 46.66245, longitude: -120.6642},
"170601": {name: "Lower Snake", latitude: 45.75422, longitude: -117.4659},
"170602": {name: "Salmon", latitude: 44.93850, longitude: -114.9479},
"170603": {name: "Clearwater", latitude: 46.19148, longitude: -115.5235},
"170701": {name: "Middle Columbia", latitude: 45.87265, longitude: -119.7252},
"170702": {name: "John Day", latitude: 44.81256, longitude: -119.4764},
"170703": {name: "Deschutes", latitude: 44.79145, longitude: -121.1090},
"170800": {name: "Lower Columbia", latitude: 46.09247, longitude: -122.2330}
}

$("#piesize_slider").on("input", function(){
	params.pie.sliderscale = +this.value/20;
	//addSurveyMarkers();
});

params.pops = {
	"0":{
		POPID: 0,
		ESU: "NA",
		MPG: "NA",
		PopName: "Unassigned"
	}
}
populations.forEach(function(d){
	params.pops[d[0]] = {
		POPID: d[0],
		ESU: d[5],
		MPG: d[6],
		PopName: (d[3].split("-")[0].trim())
	}
})

var selectSpecies = function(specie){
	species.filterAll();
	species.filter(specie);
	dc.redrawAll();
	d3.selectAll(".dc-chart g.row text").style("fill","black");
}

var selectLifestage = function(stage){
	lifestage.filterAll();
	lifestage.filter(stage)
	dc.redrawAll();
	d3.selectAll(".dc-chart g.row text").style("fill","black");
}

var redrawAll = function(){
	dc.redrawAll();
}



var species = dc.rowChart("#chart-species");
var lifestage = dc.rowChart("#chart-lifestage");
var hasdata = dc.pieChart("#chart-hasdata");
var population = dc.pieChart("#chart-pop");
var huc3name = dc.rowChart("#chart-huc3name");
var huc4name = dc.rowChart("#chart-huc4name");
var huc5name = dc.pieChart("#chart-huc5name");
var huc6name = dc.pieChart("#chart-huc6name");

queue()
	.defer(d3.csv,"QRF_HUC_Names.csv")
	.defer(d3.csv,"QRF_All.csv")
	.await(doPage)
	
function doPage(error,huc_names,data){

	function addHUCLocation(big,small){
		big.Latitude = (+big.Latitude*big.n + +small.Latitude)/(big.n + 1)
		big.Longitude = (+big.Longitude*big.n + +small.Longitude)/(big.n + 1)
		big.n++
		return big
	}

	params.huc_lookup = {}
	params.huc_locations = {}
	huc_names.forEach(function(d){
		params.huc_lookup[d.HUC12] = {level: "HUC6", name: d.HUC_12_NAME};
		params.huc_lookup[d.HUC10] = {level: "HUC5", name: d.HUC_10_NAME};
		params.huc_lookup[d.HUC8] = {level: "HUC4", name: d.HUC_8_NAME};
		params.huc_locations[d.HUC12] = {Latitude: +d.Latitude, Longitude: +d.Longitude, n: 1}
		if(!params.huc_locations[d.HUC10])params.huc_locations[d.HUC10] = {Latitude: +d.Latitude, Longitude: +d.Longitude, n: 1}
		else params.huc_locations[d.HUC10] = addHUCLocation(params.huc_locations[d.HUC10],d)
		if(!params.huc_locations[d.HUC8])params.huc_locations[d.HUC8] = {Latitude: +d.Latitude, Longitude: +d.Longitude, n: 1}
		else params.huc_locations[d.HUC8] = addHUCLocation(params.huc_locations[d.HUC8],d)		
	});
	
	Object.keys(basins).forEach(function(d){
		params.huc_lookup[d] = {level: "HUC3", name: basins[d].name}
		params.huc_locations[d] = {Latitude: basins[d].latitude, Longitude: basins[d].longitude, n: 1}
	})
	
	function processInput(d){
		d.perM = +d.perM;
		d.perM2 = +d.perM2;
		d.perM_SE = +d.perM_SE;
		d.perM2_SE = +d.perM2_SE;
		d.Longitude = +d.Longitude
		d.Latitude = +d.Latitude
		d.HasData = d.perM_SE == 0 & d.perM2_SE == 0 ? true : false;
		if(!params.huc_lookup[d.HUC_12])console.log(d.HUC_12)
		d.HUC6 = d.HUC_12.toString()
		d.HUC5 = d.HUC_12.substring(0,10)
		d.HUC4 = d.HUC_12.substring(0,8) 
		d.HUC3 = d.HUC_12.substring(0,6)
		d.HUC6name = params.huc_lookup[d.HUC6].name
		d.HUC5name = params.huc_lookup[d.HUC5].name
		d.HUC4name = params.huc_lookup[d.HUC4].name
		d.HUC3name = params.huc_lookup[d.HUC3].name		
		var pop = params.pops[d.CA_POPID.toString()]
		if(pop)d.Population = pop
		else console.log(d.CA_POPID)
		return(d)
	}
	
	data.forEach(function(d){d = processInput(d)});

	
	ndx = crossfilter(data);
	const all = ndx.groupAll();
	
	var speciesDim = ndx.dimension(function(d) {return d.Species;});
	var lifestageDim = ndx.dimension(function(d) {return d.Lifestage;});
	var populationDim = ndx.dimension(function(d) {return d.CA_POPID + "-" + d.Population.PopName;});
	var huc3Dim = ndx.dimension(function(d) {return d.HUC3;});
	var huc4Dim = ndx.dimension(function(d) {return d.HUC4;});
	var huc5Dim = ndx.dimension(function(d) {return d.HUC5;});
	var huc6Dim = ndx.dimension(function(d) {return d.HUC6;});
	var huc3nameDim = ndx.dimension(function(d) {return d.HUC3name;});
	var huc4nameDim = ndx.dimension(function(d) {return d.HUC4name;});
	var huc5nameDim = ndx.dimension(function(d) {return d.HUC5name;});
	var huc6nameDim = ndx.dimension(function(d) {return d.HUC6name;});	
	var hasdataDim = ndx.dimension(function(d) {return d.HasData;});
	
	species
	.width(350)
	.height(125)
	.margins({top: 0, left: 10, right: 10, bottom: 40})
	.dimension(speciesDim)
	.elasticX(true)
	.transitionDuration(100)
	.group(speciesDim.group())


console.log("species")	

	lifestage
	.width(350)
	.height(125)
	.margins({top: 0, left: 10, right: 10, bottom: 40})
	.dimension(lifestageDim)
	.elasticX(true)
	.transitionDuration(100)
	.group(lifestageDim.group())
	;
console.log("lifestage")


population
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value > 0; 
	  });
	})
    .width(320)
    .height(150)
    .radius(70)
	.cx(70)
	.cy(80)
	.minAngleForLabel(3)
	.legend(dc.legend().x(150).y(10).itemHeight(13).gap(5))	
	.dimension(populationDim)
	.group(populationDim.group())

	.on('postRedraw',function(){
		var dolabels = false
		if(params.leafmap){
			if(params.poplabelgroup){
				params.poplabelgroup.clearLayers()
				dolabels=true
			}
		}
		//
		if(population.filters().length > 0){
			//d3.selectAll(".wicon").style("visibility","hidden")
			population.filters().forEach(function(d){
				var popid = d.split("-")[0].trim()
				var popname = d.split("-")[1].trim()
				//d3.selectAll(".wicon.POP" + popid).style("visibility","visible")
				if(dolabels){
					addPopLabel(popid,popname)
					d3.selectAll(".poplabel").style("font-size",params.population.labelsize)
					d3.selectAll(".labeltable").style("width",params.population.labelwidth)
				}
			})
		}
	})	
	
console.log("population")

huc3name
	.width(350)
	.height(250)
	.margins({top: 0, left: 10, right: 10, bottom: 40})
	.dimension(huc3nameDim)
	.elasticX(true)
	.group(huc3nameDim.group())
	.on("postRedraw",function(d){
		rollQRF();
		doPies();
	})	
console.log("huc3")	

huc4name
	.width(350)
	.height(700)
	.margins({top: 0, left: 10, right: 10, bottom: 40})
	.dimension(huc4nameDim)
	.elasticX(true)
	.group(huc4nameDim.group())
console.log("huc4")	

huc5name
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value > 0; 
	  });
	})
    .width(320)
    .height(200)
    .radius(70)
	.cx(70)
	.cy(80)
	.minAngleForLabel(3)
	.legend(dc.legend().x(150).y(10).itemHeight(13).gap(5))	
	.dimension(huc5nameDim)
	.group(huc5nameDim.group())
	
console.log("huc5")	

	
huc6name
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value > 0; 
	  });
	})
    .width(320)
    .height(200)
    .radius(70)
	.cx(70)
	.cy(80)
	.minAngleForLabel(3)
	.legend(dc.legend().x(150).y(10).itemHeight(13).gap(5))	
	.dimension(huc6nameDim)
	.group(huc6nameDim.group())

console.log("huc6")

hasdata
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value > 0; 
	  });
	})
    .width(320)
    .height(200)
    .radius(70)
	.cx(70)
	.cy(80)
	.minAngleForLabel(3)
	.legend(dc.legend().x(150).y(10).itemHeight(13).gap(5))	
	.dimension(hasdataDim)
	.group(hasdataDim.group())

console.log("hasdata")		

	addMap();
	params.leafmap.setView([46.38,-118.62], 7);
	L.control.legend({ position: 'topleft', id: "pie_legend" }).addTo(params.leafmap);
	//addStates();

	dc.renderAll();
	species.filter("Chinook")
	lifestage.filter("Summer")
	rollQRF();
	//addDams();
	addLayerGroups();
	addHUCLayer()
	addPopBoundaries("styleFish")	
	addRivers();
	params.RiverLayer.addTo(params.leafmap)	
	addFishUse("Spring Chinook","SpChinook S&R")
	addFishUse("Summer Chinook","SuChinook S&R")
	addFishUse("Summer Steelhead","SuSteelhead S&R")
	addFishUse("Winter Steelhead","WSteelhead S&R")	
	d3.selectAll(".dc-chart g.row text").style("fill","black");
	params.leafmap.on('zoomend',function(e){
		params.QRF.aggregation_level = "HUC3";
		if(params.leafmap._zoom > 7)params.QRF.aggregation_level = "HUC4";
		if(params.leafmap._zoom > 8)params.QRF.aggregation_level = "HUC5";
		if(params.leafmap._zoom > 10)params.QRF.aggregation_level = "HUC6";
		rollQRF();
		doPies();
	})
	doPies();
	addQRF();
	params.HUC.LabelLayer = L.featureGroup().addTo(params.leafmap);
	document.getElementById("spinner").style.visibility = 'hidden';
}

function rollQRF(){
	params.QRF.rollup = d3.nest() 
		.key(function(d) { return d[params.QRF.aggregation_level]; })
		.rollup(function(v) { return {
			count: v.length,
			total: d3.sum(v, function(d) { return d.amount; }),
			perM: d3.mean(v, function(d) { return d.perM; }),
			perM2: d3.mean(v, function(d) { return d.perM2; }),
		}; })
		.entries(species.dimension().top(Infinity), d3.map)
	
	params.QRF.levelmap = {}
	params.QRF.rollup.forEach(function(d){
		params.QRF.levelmap[d.key] = d.values;
	})
}

function doPies(){
	if(!params.PieLayer){
		params.PieLayer = L.featureGroup().addTo(params.leafmap);
		params.layerControl.addOverlay(params.PieLayer, "QRF Summary Pies")
	}
	params.PieLayer.clearLayers();
	if(params.HUC.LabelLayer)params.HUC.LabelLayer.clearLayers();
	  let rmax = 30
	  //var domain = [2.5,5,7.5,10,15]
	  var domain = params.QRF.breaks[species.filter()][lifestage.filter()][params.QRF.variable]
	  var variable = params.QRF.variable
	  var range = []
	  range.push("0-" + domain[0])
	  for(var i=0;i<domain.length-1;i++)range.push(domain[i] + "-" + domain[i+1])
	  range.push("> " + domain[domain.length-1])
	  let categoryFxn = d3.scale.threshold().domain(domain).range(range);
	  let colorMap = d3.scale.threshold().domain(domain).range(colorbrewer["Reds"][6])
	  
	  var nested_data = d3.nest() 
          .key(function(d) { return d[params.QRF.aggregation_level]; })
		  .key(function(d) {
			var value = categoryFxn(d[variable]);
			return categoryFxn.range().indexOf(value)
		  })
          .entries(species.dimension().top(Infinity), d3.map)
	  
	  nested_data.forEach(function(d){
		d.sum = d3.sum(d.values,function(dd) { return dd.values.length})
		d.location = params.huc_locations[d.key];
		var myIcon = getPieIcon(d)
		var pie = L.marker([d.location.Latitude,d.location.Longitude], {icon: myIcon})
		params.PieLayer.addLayer(pie)
		
		d.name = params.huc_lookup[d.key].name

		d3.select(".HUC" + d.key)
			.on("mouseover", function() {
				
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 1);      
				tipdiv.html(d.name)	
					.style("left", (d3.event.pageX + 5) + "px")     
					.style("top", (d3.event.pageY +10) + "px");
				})                  
			.on("mouseout", function() {       
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 0);
			})	
			.on("click",function(){
				addHUCLabel(d.key,d.name,d.location)
				d3.selectAll(".huclabel").style("font-size",params.HUC.labelsize)
				d3.selectAll(".huclabeltable").style("width",params.HUC.labelwidth)				
			})
		
	})
	addPieLegend()
}

var addHUCLabel = function(id,name,location){
		var lat = location.Latitude;
		var lon = location.Longitude;
		var html, words;
		
		html = "<table class='huclabeltable'><tr><td align='left' class='huclabel'>" + name + "</td></tr></table>"
		
		var divIcon = L.divIcon({ 
		html: html,
		className: "huclabel",
		draggable: true,
		color: params.HUC.labelcolor
		})
		
		var marker = L.marker(new L.LatLng(lat, lon), {icon: divIcon })
		
		params.HUC.LabelLayer.addLayer(marker);
		    // Disable dragging when user's cursor enters the element
		marker.addEventListener('mouseover', function () {
			params.leafmap.dragging.disable();
			marker.dragging.enable();
		});
		
		marker.on('dragend', function(e) {
			
		});

    // Re-enable dragging when user's cursor leaves the element
		marker.addEventListener('mouseout', function () {
			params.leafmap.dragging.enable();
		});
		
		d3.selectAll(".huclabeltable").style("color",params.HUC.labelcolor)
		d3.selectAll(".huclabeltable td").style("font-size",params.HUC.labelsize)
}

function getPieIcon(pdata) {
		
        var n = pdata.sum, //total count
        strokeWidth = 1, //Set clusterpie stroke width
		rmax = 40,
        //r = Math.pow(params.pie.scale,1.5)*Math.sqrt(n)/10,
		//r = rmax-2*strokeWidth-(n<10?30:n<50?25:n<100?20:n<), //Calculate clusterpie radius...
		r = rmax - d3.scale.threshold().domain([10,50,100,500,1000]).range([30,20,15,10,5,2])(n);
        iconDim = (r+strokeWidth)*2, //...and divIcon dimensions (leaflet really want to know the size)
        data = []
		pdata.values.forEach(function(d){
			data.push({key: d.key, value: d.values.length})
		})
		/*
		var data = d3.nest() //Build a dataset for the pie chart
          .key(function(d) { return d.feature.properties[categoryField]; })
          .entries(children, d3.map),
		 */ 
        //bake some svg markup

        var html = bakePie({data: data,
                            valueFunc: function(d){return d.value;},
                            strokeWidth: 1,
                            outerRadius: r,
                            innerRadius: 1,
                            pieClass: 'pie HUC' + pdata.key,
                            pieLabel: n,
                            pieLabelClass: 'pie-label',
                            pathClassFunc: function(d){return "reds-" + d.data.key;},
                            //pathTitleFunc: function(d){return metadata.fields[categoryField].lookup[d.data.key]+' ('+d.data.values.length+' accident'+(d.data.values.length!=1?'s':'')+')';}
                          }),
        //Create a new divIcon and assign the svg markup to the html property
        myIcon = new L.DivIcon({
            html: html,
            className: 'marker-cluster', 
            iconSize: new L.Point(iconDim, iconDim)
        });
    return myIcon;
}

/*function that generates a svg markup for the pie chart*/
function bakePie(options) {
    /*data and valueFunc are required*/
    if (!options.data || !options.valueFunc) {
        return '';
    }
    var data = options.data,
        valueFunc = options.valueFunc,
        r = options.outerRadius?options.outerRadius:28, //Default outer radius = 28px
        rInner = options.innerRadius?options.innerRadius:r-10, //Default inner radius = r-10
        strokeWidth = options.strokeWidth?options.strokeWidth:1, //Default stroke is 1
        pathClassFunc = options.pathClassFunc?options.pathClassFunc:function(){return '';}, //Class for each path
        pathTitleFunc = options.pathTitleFunc?options.pathTitleFunc:function(){return '';}, //Title for each path
        pieClass = options.pieClass?options.pieClass:'marker-cluster-pie', //Class for the whole pie
        pieLabel = options.pieLabel?options.pieLabel:d3.sum(data,valueFunc), //Label for the whole pie
        pieLabelClass = options.pieLabelClass?options.pieLabelClass:'marker-cluster-pie-label',//Class for the pie label
        
        origo = (r+strokeWidth), //Center coordinate
        w = origo*2, //width and height of the svg element
        h = w,
        donut = d3.layout.pie().sort(function(a,b){return a.key-b.key;}),
        arc = d3.svg.arc().innerRadius(rInner).outerRadius(r);
        console.log(data)
    //Create an svg element
    var svg = document.createElementNS(d3.ns.prefix.svg, 'svg');
    //Create the pie chart
    var vis = d3.select(svg)
        .data([data])
        .attr('class', pieClass)
        .attr('width', w)
        .attr('height', h);
        
    var arcs = vis.selectAll('g.arc')
        .data(donut.value(valueFunc))
        .enter().append('svg:g')
        .attr('class', 'arc')
        .attr('transform', 'translate(' + origo + ',' + origo + ')');
    
    arcs.append('svg:path')
        .attr('class', pathClassFunc)
        .attr('stroke-width', strokeWidth)
		//.style("fill",function(d){return d.data.color;})
		//.style("background",function(d){return d.data.color;})
		//.style("stroke",function(d){return shadeColor2(d.data.color,-0.5);})
		//.style("border-color",function(d){return shadeColor2(d.data.color,-0.5);})	
        .attr('d', arc)
        .append('svg:title')
        .text(pathTitleFunc);
		

                
    vis.append('text')
        .attr('x',origo)
        .attr('y',origo)
        .attr('class', pieLabelClass)
        .attr('text-anchor', 'middle')
        //.attr('dominant-baseline', 'central')
        /*IE doesn't seem to support dominant-baseline, but setting dy to .3em does the trick*/
        .attr('dy','.3em')
        .text(pieLabel);
    //Return the svg-markup rather than the actual element
    return serializeXmlNode(svg);
}

function serializeXmlNode(xmlNode) {
    if (typeof window.XMLSerializer != "undefined") {
        return (new window.XMLSerializer()).serializeToString(xmlNode);
    } else if (typeof xmlNode.xml != "undefined") {
        return xmlNode.xml;
    }
    return "";
}

var addPieLegend = function(){
	var legend = d3.select("#pie_legend");
	legend.selectAll("svg").remove();
	var domain = params.QRF.breaks[species.filter()][lifestage.filter()][params.QRF.variable]
	var height = (domain.length + 2)*17;//17 extra for top line
	var width = 75;
		
	var range = []
	range.push("0-" + domain[0])
	for(var i=0;i<domain.length-1;i++)range.push(domain[i] + "-" + domain[i+1])
	range.push("> " + domain[domain.length-1])

	var data = []
	var maxlength=0
	for(i=0;i<range.length;i++){
		data.push({label: range[i], color: colorbrewer["Reds"][6][i]});
		maxlength = range[i].length > maxlength ? range[i].length : maxlength;
	}
	width = 35 + maxlength*8;
		
		var svg = legend.append("svg")
			.attr("height", height)
			.attr("width", width)	
		
		svg.append("rect")
			.attr("x",0)
			.attr("y",0)
			.attr("height", height)
			.attr("width", width)
			.style("fill","white")
			
		svg
			.append("g")
			.append("text")
			.attr("transform","translate(10,12)")
			.text(params.QRF.variable)
			.style("font-size",14)
			
		svg	
			.selectAll(".pielegend")
			.data(data)
			.enter()
			.append("g")
			.attr("class","pielegend")
			.attr("transform",function(d,i){
				return "translate(0," + (i*17+17) + ")";//10 extra for header
			})
		svg	
			.selectAll(".pielegend")
			.append("line")
			.attr("x1",5).attr("y1",5).attr("x2",30).attr("y2",5)
			.style("stroke",function(d){return d.color})
			.style("stroke-width",4)			
		svg	
			.selectAll(".pielegend")
			.append("text")
			.attr("transform","translate(35,10)")
			.text(function(d){return d.label})
			.style("font-size",14)
			
		svg
			.on("mouseover", function() {
			tipdiv.transition()        
				.duration(20)      
				.style("opacity", 1);      
			tipdiv.html("")
				.style("width",500)
				.style("left", (d3.event.pageX + 5) + "px")     
				.style("top", (d3.event.pageY +10) + "px");
			})                  
			.on("mouseout", function() {       
			tipdiv.transition()        
				.duration(20)      
				.style("opacity", 0);
			});		
				
}

var QRFColor = function(properties){
	return d3.scale.threshold().domain(params.QRF.breaks[species.filter()][lifestage.filter()][params.QRF.variable]).range(colorbrewer["Reds"][6])(properties["perM"])
	//return "#ccc"
}

function hasData(properties){
	return properties.perM_SE == 0 & properties.perM2_SE == 0
}

var QRFTileOptions = {
	rendererFactory: L.canvas.tile,
    vectorTileLayerStyles: {
        // A function for styling features dynamically, depending on their
        // properties and the map's zoom level
        CHNK_SUM_QRFgeojson: function(properties, zoom) {
			var opacity = lifestage.filter()== "Summer" & species.filter()== "Chinook" ? 1 : 0
			var styles = {
                radius: 2,
                color: hasData(properties) ? "black" : QRFColor(properties),
				fill: true,
				fillColor: hasData(properties) ? "black" : QRFColor(properties),
                opacity: opacity,
				fillOpacity: opacity
            }
			return styles;
        },
        CHNK_WIN_QRFgeojson: function(properties, zoom) {
			var opacity = lifestage.filter()== "Overwinter" & species.filter()== "Chinook" ? 1 : 0
			var styles = {
                radius: 2,
                color: QRFColor(properties),
				fill: true,
				weight: 1,
				fillColor: QRFColor(properties),
                opacity: opacity,
				fillOpacity: opacity
            }
			return styles;
        },
        CHNK_REDD_QRFgeojson: function(properties, zoom) {
			var opacity = lifestage.filter()== "Redds" & species.filter()== "Chinook" ? 1 : 0
			var styles = {
                radius: 2,
                color: QRFColor(properties),
				fill: true,
				weight: 1,
				fillColor: QRFColor(properties),
                opacity: opacity,
				fillOpacity: opacity
            }
			return styles;
        },
        STHD_SUM_QRFgeojson: function(properties, zoom) {
			var opacity = lifestage.filter()== "Summer" & species.filter()== "Steelhead" ? 1 : 0
			var styles = {
                radius: 2,
                color: QRFColor(properties),
				fill: true,
				weight: 1,
				fillColor: QRFColor(properties),
                opacity: opacity,
				fillOpacity: opacity
            }
			return styles;
        },
        STHD_WIN_QRFgeojson: function(properties, zoom) {
			var opacity = lifestage.filter()== "Overwinter" & species.filter()== "Steelhead" ? 1 : 0
			var styles = {
                radius: 2,
                color: QRFColor(properties),
				fill: true,
				weight: 1,
				fillColor: QRFColor(properties),
                opacity: opacity,
				fillOpacity: opacity
            }
			return styles;
        },
        STHD_REDD_QRFgeojson: function(properties, zoom) {
			var opacity = lifestage.filter()== "Redds" & species.filter()== "Steelhead" ? 1 : 0
			var styles = {
                radius: 2,
                color: QRFColor(properties),
				fill: true,
				weight: 1,
				fillColor: QRFColor(properties),
                opacity: opacity,
				fillOpacity: opacity
            }
			return styles;
        }		
    }
};

var addQRF = function(){
	var Url = tileserver_url + "tileserver.php?/index.json?/QRF/{z}/{x}/{y}.pbf"
	var QRFTileLayer = L.vectorGrid.protobuf(Url,QRFTileOptions)
	params.layerControl.addOverlay(QRFTileLayer, "QRF Sites")
}

popstyles.styleFish = {
		fxn: function(properties,zoom){
			var color = "gray";
			var style, poptype, opacity, fopacity;
			
			if(population.filters().length>0 & properties.NMFS_COMMO == species.filter()){
				poptype = "Background"
				population.filters().forEach(function(d){
					if(d.split("-")[0] == properties.CA_POPID)poptype = "Highlight"
				})
				if(poptype == "Highlight"){
					opacity = .8
					style = {
						color: params.population.color,
						opacity: opacity,
						fillOpacity: 0,
						weight: 2
					}												
				}
				else {
					opacity = .7
					opacity =  properties.LISTING_ST == "Threatened" | properties.LISTING_ST == "Endangered" ? opacity : 0;
					opacity =  properties.POPSTATUS == "Extant" | properties.POPSTATUS == "Reintroduction" ? opacity : 0;

					style = {
						color: color,
						opacity: opacity,
						fillOpacity: opacity*.7,
						fill: color,
						weight: 2
					}									
				}
			}
			else {
				style = {
					color: "white",
					opacity: 0,
					weight: 1
				}			
			}
			
			return style;


			var style = {
							color: color,
							opacity: opacity,
							weight: 2
						}
			return style;			
		},
		label: "Populations"
}

var addPopLabel = function(id,label){
		var lat = params.population.centroids[id].Lat;
		var lon = params.population.centroids[id].Lon
		var html, words;
		html = "<table class='poplabeltable'><tr><td align='left' class='poplabel'>" + label + "</td></tr></table>"				
		var divIcon = L.divIcon({ 
		html: html,
		className: "LABEL" + id,
		draggable: true
		})
		
		var marker = L.marker(new L.LatLng(lat, lon), {icon: divIcon })
		
		params.poplabelgroup.addLayer(marker);
		    // Disable dragging when user's cursor enters the element
		marker.addEventListener('mouseover', function () {
			params.leafmap.dragging.disable();
			marker.dragging.enable();
		});
		
		marker.on('dragend', function(e) {
		var id = this.options.icon.options.className.substring(5);
		var centroid = params.population.centroids[id];
		coord = marker.getLatLng();
		centroid.Lat = [coord.lng];	
		centroid.Lon = [coord.lat];		
		});

    // Re-enable dragging when user's cursor leaves the element
		marker.addEventListener('mouseout', function () {
			params.leafmap.dragging.enable();
		});
		d3.selectAll(".poplabeltable").style("color",params.population.labelcolor)
		d3.selectAll(".poplabeltable td").style("font-size",params.population.labelsize)
}
	
var buildHUCStyle = function(variable){
	var fxn = function(properties,zoom){
			var hucname = "NA";
			var huc;
			huc = params.huc_lookup[properties[variable]]
			if(huc)hucname = properties[variable]
			if(hucname == "NA" | !params.QRF.rollup){
				var style = {
								color: "green",
								opacity: 0,
								weight: 0,
								fillOpacity: 0,
								fill: "orange"
							}
				return style;			
			}
			else{
				var color = d3.scale.threshold().domain(params.QRF.breaks[species.filter()][lifestage.filter()][params.QRF.variable]).range(colorbrewer["Reds"][6])
				var opacity = 0;
				var value = 0
				if(params.QRF.levelmap[hucname.toString()]){
					opacity = 1
					value = params.QRF.levelmap[hucname][params.QRF.variable]
				}
				var style;
				switch(params.HUC.style) {
				  case "valuefill":
					style = {
						color: params.HUC.bordercolor,
						opacity: opacity,
						fillOpacity: opacity,
						fillColor: color(value),
						weight: 2,
						fill: true
					}
					break;
				  default:
					style = {
						color: params.HUC.bordercolor,
						opacity: opacity,
						weight: 2,
						fill: false
					}				  
				}
				return style;			
			}	
	
	}
	return fxn;
}


function addHUCLayer(){
	var Url = tileserver_url + "tileserver.php?/index.json?/HUC/{z}/{x}/{y}.pbf"
	var HUCOptions = {
		rendererFactory: L.svg.tile,
		attribution: 'NHD',
		vectorTileLayerStyles: {
			HUC3geojson: buildHUCStyle("HUC6"),
			HUC4geojson: buildHUCStyle("HUC8"),
			HUC5geojson: buildHUCStyle("HUC10"),
			HUC6geojson: buildHUCStyle("HUC_12"),
		},
		getFeatureId: function(f) {
			switch(params.QRF.aggregation_level) {
			  case "HUC3":
			    return f.properties.HUC6
				break;	
			  case "HUC4":
			    return f.properties.HUC8
				break;
			  case "HUC5":
			    return f.properties.HUC10
				break;					
			  default:
				return f.properties.HUC_12;
		}	
		}
	};
	
	var huclayer = L.vectorGrid.protobuf(Url,HUCOptions)
	params.layerControl.addOverlay(huclayer, "HUC")
}

var plotDensity = function(survived){
	var keys = []
	for(i=60;i<244;i++)keys.push(i);
	var kdata = []
	
	
	
	arrday.group().top(Infinity).forEach(function(day){
		var total = survived ? getSurvived(day) : day.value.total;
		for(j=0;j<total;j++)kdata.push(day.key)
	})

	var density = kernelDensityEstimator(kernelEpanechnikov(7), keys)(kdata);
	
	var y2 = d3.scale.linear().domain([0,.1]).range(arrday.y().range())

    var line= d3.svg.line().x(function (d) {
         return arrday.x()(new Date(2018, 0, d[0])) + arrday.margins().top;
     }).y(function (d) {
        return y2(d[1]) + arrday.margins().left;
    }).interpolate("linear")

    arrday.svg()
		.append("path")
		.attr("d",line(density))
		.style("fill","none")
		.style("stroke-width",2)
		.style("stroke",survived ? "green" : "blue")	
}

const copyToClipboard = str => {
  const el = document.createElement('textarea');
  el.value = str;
  document.body.appendChild(el);
  el.select();
  document.execCommand('copy');
  document.body.removeChild(el);
  console.log("copied to clipboard")
};

var writeCSV = function(csv, filename){
//from https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
const rows = [["name1", "city1", "some other info"], ["name2", "city2", "more info"]];
let csvContent = "data:text/csv;charset=utf-8,";
rows.forEach(function(rowArray){
   let row = rowArray.join(",");
   csvContent += row + "\r\n";
});

var encodedUri = encodeURI(csvContent);
var link = document.createElement("a");
link.setAttribute("href", encodedUri);
link.setAttribute("download", "my_data.csv");
document.body.appendChild(link); // Required for FF

link.click(); // This will download the data file named "my_data.csv".

}


  
function kernelDensityEstimator(kernel, X) {
  return function(V) {
    return X.map(function(x) {
      return [x, d3.mean(V, function(v) { return kernel(x - v); })];
    });
  };
}

function kernelEpanechnikov(k) {
  return function(v) {
    return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
  };
} 

var wilsonScore = function (positiveScore, total) {
//from https://github.com/msn0/wilson-score-interval
    if (total === 0) {
        return {
            left: 0,
            right: 0
        };
    }

    // phat is the proportion of successes
    // in a Bernoulli trial process
    const phat = positiveScore / total;

    // z is 1-alpha/2 percentile of a standard
    // normal distribution for error alpha=5%
    const z = 1.96;

    // implement the algorithm
    // (http://goo.gl/kgmV3g)
    const a = phat + z * z / (2 * total);
    const b = z * Math.sqrt((phat * (1 - phat) + z * z / (4 * total)) / total);
    const c = 1 + z * z / total;

    return {
        left: (a - b) / c,
        right: (a + b) / c
    };
};

var cloneSVG = function(chart,target){
	var index = d3.select("#gallery").selectAll("svg")[0].length;
	var svg = chart.svg().node().cloneNode(true)
	var text = d3.select('#clone_text').node().value
	$("#" + target).append("<h4 class='gallery" + index + "'>" + text + "</h4>")
	$("#" + target).append(svg);// append the img to the DOM
	$("#" + target).append("<br class='gallery" + index + "'/>")	
	d3.select('#clone_text').node().value = ""
	//attribute up the added
	d3.select("#gallery").selectAll("svg").each(function(d,i){
		if(i==index){
			var _svg = d3.select(this)
			_svg.attr("class","gallery" + index)
			addCloseButton(_svg,index)
		}	
	})
}

var addCloseButton = function(svg1,index){
	var width = svg1.attr("width")
	svg1
	  .append("image")
      .attr("xlink:href", "close_icon.jpg")
      .attr("x", width-22)
      .attr("y", 0)
      .attr("width", 20)
      .attr("height", 20)
	  .attr("class", "close_button")
	  .style("opacity",1)
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('Delete This')  
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 10) + "px");    
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);   
		})
	  .on("click", function(d){			
		d3.selectAll(".gallery" + index).remove();
		tipdiv.style("opacity", 0);
		});
}

var createImagePlot = function(chart,target){
	 svgString = getSVGString(chart.svg().node())
	 var imgElem = svgString2Image( svgString, chart.width(), chart.height(), 'png');
	 console.log(d3.select('#' + target))
	 $('#'+target).append(imgElem);// append the img to the DOM
	 $('#'+target).append("<br/>")
   }

// Below are the functions that handle actual exporting:
// getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
function getSVGString( svgNode ) {
	svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
	var cssStyleText = getCSSStyles( svgNode );
	appendCSS( cssStyleText, svgNode );

	var serializer = new XMLSerializer();
	var svgString = serializer.serializeToString(svgNode);
	svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
	svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

	return svgString;

	function getCSSStyles( parentElement ) {
		var selectorTextArr = [];

		// Add Parent element Id and Classes to the list
		selectorTextArr.push( '#'+parentElement.id );
		for (var c = 0; c < parentElement.classList.length; c++)
				if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
					selectorTextArr.push( '.'+parentElement.classList[c] );

		// Add Children element Ids and Classes to the list
		var nodes = parentElement.getElementsByTagName("*");
		for (var i = 0; i < nodes.length; i++) {
			var id = nodes[i].id;
			if ( !contains('#'+id, selectorTextArr) )
				selectorTextArr.push( '#'+id );

			var classes = nodes[i].classList;
			for (var c = 0; c < classes.length; c++)
				if ( !contains('.'+classes[c], selectorTextArr) )
					selectorTextArr.push( '.'+classes[c] );
		}

		// Extract CSS Rules
		var extractedCSSText = "";
		for (var i = 0; i < document.styleSheets.length; i++) {
			var s = document.styleSheets[i];
			
			try {
			    if(!s.cssRules) continue;
			} catch( e ) {
		    		if(e.name !== 'SecurityError') throw e; // for Firefox
		    		continue;
		    	}

			var cssRules = s.cssRules;
			for (var r = 0; r < cssRules.length; r++) {
				if ( contains( cssRules[r].selectorText, selectorTextArr ) )
					extractedCSSText += cssRules[r].cssText;
			}
		}
		

		return extractedCSSText;

		function contains(str,arr) {
			return arr.indexOf( str ) === -1 ? false : true;
		}

	}

	function appendCSS( cssText, element ) {
		var styleElement = document.createElement("style");
		styleElement.setAttribute("type","text/css"); 
		styleElement.innerHTML = cssText;
		var refNode = element.hasChildNodes() ? element.children[0] : null;
		element.insertBefore( styleElement, refNode );
	}
}


//function svgString2Image( svgString, width, height, format, callback ) {
function svgString2Image( svgString, width, height, format) {
	var format = format ? format : 'png';

	var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

	var canvas = document.createElement("canvas");
	var context = canvas.getContext("2d");

	canvas.width = width;
	canvas.height = height;

	var image = new Image();
	image.onload = function() {
		context.clearRect ( 0, 0, width, height );
		context.drawImage(image, 0, 0, width, height);

		canvas.toBlob( function(blob) {
			var filesize = Math.round( blob.length/1024 ) + ' KB';
			//if ( callback ) callback( blob, filesize );
		});

		
	};

	image.src = imgsrc;
	return(image)
} 

params.population.centroids =
{
  "2": {"Lon": -116.612,"Lat": 46.377},
  "3": {"Lon": -116.133,"Lat": 46.121},
  "4": {"Lon": -116.592,"Lat": 46.745},
  "5": {"Lon": -115.671,"Lat": 45.799},
  "6": {"Lon": -116.984,"Lat": 45.383},
  "7": {"Lon": -117.83,"Lat": 45.266},
  "8": {"Lon": -118.331,"Lat": 45.235},
  "9": {"Lon": -116.841,"Lat": 45.414},
  "10": {"Lon": -117.936,"Lat": 45.794},
  "11": {"Lon": -117.409,"Lat": 45.459},
  "12": {"Lon": -117.578,"Lat": 45.321},
  "13": {"Lon": -117.712,"Lat": 46.009},
  "14": {"Lon": -117.279,"Lat": 46.231},
  "15": {"Lon": -117.768,"Lat": 46.382},
  "16": {"Lon": -115.415,"Lat": 44.391},
  "17": {"Lon": -115.112,"Lat": 45.113},
  "18": {"Lon": -114.512,"Lat": 44.854},
  "19": {"Lon": -115.168,"Lat": 45.495},
  "20": {"Lon": -114.738,"Lat": 44.61},
  "21": {"Lon": -115.114,"Lat": 44.404},
  "22": {"Lon": -114.755,"Lat": 45.151},
  "23": {"Lon": -115.171,"Lat": 44.702},
  "24": {"Lon": -115.43,"Lat": 44.552},
  "25": {"Lon": -115.48,"Lat": 44.846},
  "26": {"Lon": -116.271,"Lat": 45.374},
  "27": {"Lon": -115.85,"Lat": 45.187},
  "28": {"Lon": -115.762,"Lat": 45.212},
  "29": {"Lon": -114.36,"Lat": 44.082},
  "30": {"Lon": -113.551,"Lat": 44.861},
  "31": {"Lon": -114.08,"Lat": 45.459},
  "32": {"Lon": -113.769,"Lat": 44.426},
  "33": {"Lon": -114.323,"Lat": 45.158},
  "34": {"Lon": -114.269,"Lat": 44.565},
  "35": {"Lon": -114.848,"Lat": 43.993},
  "36": {"Lon": -115.041,"Lat": 44.267},
  "37": {"Lon": -114.701,"Lat": 44.413},
  "38": {"Lon": -115.02,"Lat": 46.392},
  "39": {"Lon": -115.908,"Lat": 46.416},
  "40": {"Lon": -115.975,"Lat": 46.819},
  "41": {"Lon": -115.316,"Lat": 45.975},
  "42": {"Lon": -114.916,"Lat": 46.19},
  "43": {"Lon": -115.323,"Lat": 46.715},
  "44": {"Lon": -114.724,"Lat": 45.862},
  "45": {"Lon": -120.489,"Lat": 47.872},
  "46": {"Lon": -120.246,"Lat": 48.526},
  "47": {"Lon": -120.788,"Lat": 47.713},
  "57": {"Lon": -120.441,"Lat": 44.035},
  "58": {"Lon": -120.895,"Lat": 44.866},
  "59": {"Lon": -121.46,"Lat": 44.82},
  "60": {"Lon": -121.228,"Lat": 45.493},
  "61": {"Lon": -121.133,"Lat": 46.026},
  "62": {"Lon": -120.512,"Lat": 45.87},
  "63": {"Lon": -121.579,"Lat": 45.951},
  "64": {"Lon": -120.184,"Lat": 44.996},
  "65": {"Lon": -118.942,"Lat": 44.415},
  "66": {"Lon": -118.859,"Lat": 44.717},
  "67": {"Lon": -119.012,"Lat": 44.934},
  "68": {"Lon": -119.431,"Lat": 44.179},
  "69": {"Lon": -118.167,"Lat": 46.275},
  "70": {"Lon": -119.203,"Lat": 45.712},
  "71": {"Lon": -118.432,"Lat": 46.005},
  "72": {"Lon": -119.873,"Lat": 45.491},
  "73": {"Lon": -120.871,"Lat": 46.677},
  "74": {"Lon": -120.091,"Lat": 46.217},
  "75": {"Lon": -120.771,"Lat": 46.367},
  "76": {"Lon": -120.738,"Lat": 47.094},
  "77": {"Lon": -116.356,"Lat": 46.39},
  "78": {"Lon": -114.962,"Lat": 46.412},
  "79": {"Lon": -115.794,"Lat": 46.34},
  "80": {"Lon": -115.584,"Lat": 46.757},
  "81": {"Lon": -114.914,"Lat": 45.981},
  "82": {"Lon": -115.664,"Lat": 45.796},
  "83": {"Lon": -117.522,"Lat": 45.923},
  "84": {"Lon": -118.085,"Lat": 45.343},
  "85": {"Lon": -117.092,"Lat": 45.747},
  "86": {"Lon": -117.451,"Lat": 45.425},
  "87": {"Lon": -116.641,"Lat": 45.669},
  "89": {"Lon": -116.899,"Lat": 45.402},
  "90": {"Lon": -117.229,"Lat": 46.348},
  "91": {"Lon": -117.95,"Lat": 46.525},
  "92": {"Lon": -114.813,"Lat": 44.938},
  "93": {"Lon": -115.503,"Lat": 45.462},
  "94": {"Lon": -114.282,"Lat": 44.323},
  "95": {"Lon": -113.551,"Lat": 44.861},
  "96": {"Lon": -116.349,"Lat": 45.553},
  "97": {"Lon": -115.19,"Lat": 44.607},
  "98": {"Lon": -114.08,"Lat": 45.459},
  "99": {"Lon": -113.856,"Lat": 44.616},
  "100": {"Lon": -114.467,"Lat": 45.246},
  "101": {"Lon": -114.765,"Lat": 44.203},
  "102": {"Lon": -115.85,"Lat": 45.187},
  "103": {"Lon": -115.582,"Lat": 44.908},
  "104": {"Lon": -119.248,"Lat": 47.021},
  "105": {"Lon": -120.444,"Lat": 47.825},
  "106": {"Lon": -120.223,"Lat": 48.487},
  "107": {"Lon": -119.51,"Lat": 49.332},
  "108": {"Lon": -120.516,"Lat": 47.509},
  "293": {"Lon": -121.746,"Lat": 46.378},
  "294": {"Lon": -122.696,"Lat": 46.149},
  "295": {"Lon": -122.433,"Lat": 45.825},
  "296": {"Lon": -122.433,"Lat": 45.825},
  "297": {"Lon": -122.558,"Lat": 46.074},
  "298": {"Lon": -122.558,"Lat": 46.074},
  "299": {"Lon": -122.842,"Lat": 46.402},
  "300": {"Lon": -122.123,"Lat": 46.068},
  "301": {"Lon": -122.123,"Lat": 46.068},
  "302": {"Lon": -122.439,"Lat": 46.329},
  "303": {"Lon": -122.599,"Lat": 45.721},
  "304": {"Lon": -121.986,"Lat": 45.383},
  "305": {"Lon": -122.483,"Lat": 46.239},
  "306": {"Lon": -122.314,"Lat": 46.604},
  "307": {"Lon": -121.847,"Lat": 46.597},
  "308": {"Lon": -122.293,"Lat": 45.675},
  "309": {"Lon": -122.293,"Lat": 45.675},
  "310": {"Lon": -121.638,"Lat": 45.51},
  "311": {"Lon": -121.638,"Lat": 45.51},
  "312": {"Lon": -122.065,"Lat": 45.596},
  "313": {"Lon": -121.822,"Lat": 45.816},
  "314": {"Lon": -121.905,"Lat": 45.866},
  "315": {"Lon": -122.193,"Lat": 45.191},
  "316": {"Lon": -122.877,"Lat": 44.399},
  "317": {"Lon": -122.622,"Lat": 45.051},
  "318": {"Lon": -122.231,"Lat": 44.715},
  "319": {"Lon": -122.523,"Lat": 44.518},
  "346": {"Lon": -118.953,"Lat": 48.282},
  "347": {"Lon": -118.271,"Lat": 48.538},
  "348": {"Lon": -117.543,"Lat": 49.061},
  "349": {"Lon": -117.773,"Lat": 49.72},
  "350": {"Lon": -117.755,"Lat": 47.882},
  "351": {"Lon": -117.153,"Lat": 47.378},
  "352": {"Lon": -117.448,"Lat": 44.901},
  "353": {"Lon": -117.728,"Lat": 44.53},
  "354": {"Lon": -116.669,"Lat": 44.531},
  "355": {"Lon": -116.494,"Lat": 44.105},
  "356": {"Lon": -116.049,"Lat": 44.518},
  "357": {"Lon": -115.604,"Lat": 44.206},
  "358": {"Lon": -115.787,"Lat": 43.672},
  "359": {"Lon": -117.632,"Lat": 44.022},
  "360": {"Lon": -118.363,"Lat": 43.758},
  "361": {"Lon": -117.464,"Lat": 42.961},
  "362": {"Lon": -116.602,"Lat": 41.985},
  "363": {"Lon": -116.044,"Lat": 42.649},
  "364": {"Lon": -115.479,"Lat": 43.137},
  "365": {"Lon": -114.871,"Lat": 42.286},
  "366": {"Lon": -117.044,"Lat": 44.961},
  "367": {"Lon": -116.681,"Lat": 44.965},
  "368": {"Lon": -117.273,"Lat": 44.902},
  "369": {"Lon": -117.812,"Lat": 44.864},
  "370": {"Lon": -117.851,"Lat": 44.528},
  "371": {"Lon": -116.674,"Lat": 44.347},
  "372": {"Lon": -116.628,"Lat": 44.542},
  "373": {"Lon": -116.463,"Lat": 44.793},
  "374": {"Lon": -116.617,"Lat": 44.107},
  "375": {"Lon": -116.405,"Lat": 44.092},
  "376": {"Lon": -115.694,"Lat": 44.161},
  "377": {"Lon": -116.011,"Lat": 44.687},
  "378": {"Lon": -115.787,"Lat": 43.672},
  "379": {"Lon": -117.633,"Lat": 44.113},
  "380": {"Lon": -117.966,"Lat": 43.909},
  "381": {"Lon": -118.396,"Lat": 43.67},
  "382": {"Lon": -117.501,"Lat": 42.995},
  "383": {"Lon": -117.115,"Lat": 42.16},
  "384": {"Lon": -116.388,"Lat": 41.654},
  "385": {"Lon": -116.324,"Lat": 42.188},
  "386": {"Lon": -115.966,"Lat": 43.072},
  "387": {"Lon": -115.67,"Lat": 42.495},
  "388": {"Lon": -115.636,"Lat": 42.063},
  "389": {"Lon": -114.796,"Lat": 42.029},
  "390": {"Lon": -114.476,"Lat": 42.436},
  "393": {"Lon": -118.797,"Lat": 48.432},
  "394": {"Lon": -118.271,"Lat": 48.538},
  "395": {"Lon": -117.684,"Lat": 49.618},
  "396": {"Lon": -117.755,"Lat": 47.882},
  "397": {"Lon": -117.153,"Lat": 47.378},
  "398": {"Lon": -119.5,"Lat": 49.365}
}

	
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18774702-1', 'auto');
  ga('send', 'pageview');

</script>
</html>